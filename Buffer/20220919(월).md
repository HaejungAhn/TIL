### topic: Task, `@MainActor`, Actor, non-isolatedì˜ ì˜ë¯¸


### í•œ ë©”ì†Œë“œì— ì•„ëž˜ì™€ ê°™ì€ êµ¬ì¡°ê°€ ë“¤ì–´ê°€ë©´ ì–´ë–»ê²Œ ë ê¹Œ?

```swift
func something() {
	.. ëª‡ëª‡ ìž‘ì—…ë“¤ // (1)
	Task {
		// some task
	}
	.. ëª‡ëª‡ ìž‘ì—…ë“¤ // (2) ì—¬ê¸°ì„œë„ ë©ˆì·„ë‹¤ê°€ ì‹¤í–‰ë˜ëŠ”ê±¸ê¹Œ?
}
```

- Test Code

    ```swift
    import UIKit
    import Combine

    func someLongTask() async  {
        print("ðŸ¯ someLongTask start!")
        try? await Task.sleep(nanoseconds: 5 * 1_000_000_000) // 1 second
        let randomNumber = Int.random(in: 1 ... 6)
        print("ðŸ¯ someLongTask end, random number is \(randomNumber)")
    }

    func doSomething() {
        print("ðŸ¹ some task 1...")
        print("ðŸ¹ some task 2...")

        Task {
            print("ðŸ¸ Task block start")
            await someLongTask()
            await someLongTask()
            print("ðŸ¸ Task block end")
        }

        print("ðŸ¹ some task 3...")
    }

    doSomething()

    // ê²°ê³¼ëŠ” ì•„ëž˜ì™€ ê°™ìŒ.
    ðŸ¹ some task 1...
    ðŸ¹ some task 2...
    ðŸ¸ Task block start
    ðŸ¯ someLongTask start!
    ðŸ¹ some task 3...
    ðŸ¯ someLongTask end, random number is 4
    ðŸ¯ someLongTask start!
    ðŸ¯ someLongTask end, random number is 1
    ðŸ¸ Task block end
    ```


(2) ë²ˆì˜ ì‹¤í–‰ì€ Taskì— ìžˆëŠ” ë©”ì†Œë“œê°€ ì™„ì „ížˆ ì¢…ë£Œëœ ì´í›„ ì‹¤í–‰ë˜ëŠ” ê±¸ê¹Œ ê¶ê¸ˆí•´ì„œ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë´¤ë‹¤.

ê²°ê³¼ëŠ” â€œê¸°ë‹¤ë¦¬ì§€ ì•ŠëŠ”ë‹¤â€ ì´ë‹¤. ì™œëƒí•˜ë©´ TaskëŠ” unstructure taskì´ê¸° ë•Œë¬¸ì— doSomething() í•¨ìˆ˜ê°€ ì‹¤í–‰ë˜ëŠ” ìŠ¤ë ˆë“œ(?)ì™€ëŠ” ë³„ë„ë¡œ ë™ìž‘í•¨. (ë‚´ê°€ ì´í•´í•œê²Œ ë§žë‚˜..)

ë§Œì•½ ìœ„ Test Codeê°€ structure taskì˜€ë‹¤ë©´ ì–´ë• ì„ê¹Œ? async/awaitì´ í•œ ì˜ˆì¸ë° doSomething() í•¨ìˆ˜ë¥¼ asyncë¡œ ë§Œë“¤ì–´ í˜¸ì¶œí•˜ë©´ await ëœ í›„ ë©”ì†Œë“œê°€ ì‹¤í–‰ë¨.

- async/awaitì„ ì‚¬ìš©í•œ Test Code

    ```swift
    import UIKit
    import Combine

    func someLongTask() async  {
        print("ðŸ¯ someLongTask start!")
        try? await Task.sleep(nanoseconds: 5 * 1_000_000_000) // 1 second
        let randomNumber = Int.random(in: 1 ... 6)
        print("ðŸ¯ someLongTask end, random number is \(randomNumber)")
    }

    func doSomething() async {
        print("ðŸ¹ some task 1...")
        print("ðŸ¹ some task 2...")

        //Task {
            print("ðŸ¸ Task block start")
            await someLongTask()
            await someLongTask()
            print("ðŸ¸ Task block end")
        //}

        print("ðŸ¹ some task 3...")
    }

    Task {
        await doSomething()
    }
    ```


Task {}ë¥¼ ì‚¬ìš©í•˜ë©´ asyncê°€ ì•„ë‹Œ ë©”ì†Œë“œì—ì„œë„ async í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•  ìˆ˜ ìžˆë‹¤ëŠ” ìž¥ì ì´ ìžˆì§€ë§Œ ìžì¹« ì½”ë“œì— ëŒ€í•œ ì¶”ë¡ ì´ ë” ì–´ë ¤ì›Œì§ˆ ìˆ˜ë„ ìžˆì„ ê²ƒ ê°™ë‹¤ëŠ” ìƒê°ì´ ë“ ë‹¤.

### `@MainActor`ë¥¼ ë¹„ë™ê¸°ê°€ ì•„ë‹Œ í•¨ìˆ˜ì—ë„ ë¶™ì¼ ìˆ˜ ìžˆì„ê¹Œ?

ë“¤ì–´ê°€ê¸°ì— ì•žì„œ Actorì— ëŒ€í•´ ì•„ëŠ”ë°ë¡œ ì ì–´ë³´ìž.

- ActorëŠ” ì—¬ëŸ¬ ìŠ¤ë ˆë“œ(ì•„ë‹˜ Task?)ì—ì„œ ë™ì‹œì— ì ‘ê·¼í•˜ë”ë¼ë„ data raceê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜ì„ ì œê³µí•¨. Actor ì•ˆì— ìžˆëŠ” ë°ì´í„°ë“¤ì€ í•œë²ˆì— í•˜ë‚˜ì˜ Taskì—ì„œë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤. ë™ì‹œì— ì ‘ê·¼í•œ ë‹¤ë¥¸ TaskëŠ” ì´ì „ Taskì˜ ìž‘ì—…ì´ ëë‚ ë•Œê¹Œì§€ ëŒ€ê¸°í•˜ê²Œ ëœë‹¤. ([ì—¬ê¸°](https://www.notion.so/2022-09-16-7507b33e29964a9e8e6fe61392820d0e)ì— í•´ë‹¹ë˜ëŠ” ê¼¬ë¦¬ì§ˆë¬¸ì´ ìƒê°ë‚¨)
- GCDì™€ ë‹¬ë¦¬ AcotrëŠ” ìš”ì²­ì´ ë“¤ì–´ì˜¨ ìˆœì„œëŒ€ë¡œ ì¼ì„ ì²˜ë¦¬í•˜ì§€ ì•ŠëŠ”ë‹¤. ìš°ì„ ìˆœìœ„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¼ì„ ì²˜ë¦¬í•œë‹¤.
- ë©”ì¸ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ë˜ëŠ” Actorë¥¼ MainActorë¼ê³  ë¶€ë¥¸ë‹¤.
- Test Code in Playground

    ```swift
    // 1. í•¨ìˆ˜ ì„ ì–¸í•˜ê¸°
    @MainActor
    func testMainActor() {
    	print("testMainActor")
    }

    // 2. í•¨ìˆ˜ í˜¸ì¶œí•˜ê¸°
    //
    // ë™ê¸°(synchronous) ë¹„ê²©ë¦¬(nonisolated) ì»¨í…ìŠ¤íŠ¸ ì•ˆì—ì„œ main actor ê²©ë¦¬ ê¸€ë¡œë²Œ í•¨ìˆ˜ì¸ 'testMainActor()'ë¥¼ í˜¸ì¶œí•¨.
    testMainActor()

    // ì•„ëž˜ì™€ ê°™ì´ ì‚¬ìš©í•´ì•¼ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•ŠìŒ.
    Task {
    	// await í‚¤ì›Œë“œë¥¼ ëˆ„ë½í•˜ë©´ ì•„ëž˜ì™€ ê°™ì€ ì—ëŸ¬ë©”ì„¸ì§€ê°€ ë‚˜ì˜´.
    	// Expression is 'async' but is not marked with 'await'
    	await testMainActor()
    }
    ```

    **í•¨ìˆ˜ ì„ ì–¸í•˜ê¸°**

    ë¹„ë™ê¸°ê°€ ì•„ë‹Œ í•¨ìˆ˜ì—ë„ `@MainActor` ì–´íŠ¸ë¦¬ë·°íŠ¸ë¥¼ ì¶”ê°€í•  ìˆ˜ ìžˆë‹¤.

    **í•¨ìˆ˜ í˜¸ì¶œí•˜ê¸°**

    ìœ„ ì½”ë“œì˜ 2ë²ˆê³¼ ê°™ì´ í•¨ìˆ˜ í˜¸ì¶œ ì‹œ ì•„ëž˜ì™€ ê°™ì€ ì—ëŸ¬ ë©”ì„¸ì§€ê°€ ë°œìƒí•œë‹¤.

    *Call to main actor-isolated global function 'testMainActor()' in a synchronous nonisolated context*

    actor ì»¨í…ìŠ¤íŠ¸ ì™¸ë¶€ì—ì„œ í•´ë‹¹ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì€ ì•”ì‹œì ìœ¼ë¡œ asynchronous í•˜ë‹¤ê³  í•œë‹¤. ë”°ë¼ì„œ ë¹„ë™ê¸°ì ìœ¼ë¡œ í˜¸ì¶œë˜ì–´ì§ˆ ìˆ˜ ìžˆë„ë¡ ì²˜ë¦¬ë¥¼ í•´ì•¼í•œë‹¤.(async í•¨ìˆ˜ì—ì„œ í˜¸ì¶œí•˜ê±°ë‚˜, Task í´ë¡œì € ë‚´ì—ì„œ í˜¸ì¶œ) ì´ë•Œ í•´ë‹¹ í•¨ìˆ˜ëŠ” await í‚¤ì›Œë“œì™€ í•¨ê»˜ ì‹¤í–‰ë˜ì–´ì•¼ í•œë‹¤.

    *ì•”ì‹œì ìœ¼ë¡œ asynchronousí•œ ì´ìœ 

    ë™ì‹œì— ì—¬ëŸ¬ ìŠ¤ë ˆë“œì—ì„œ actorì˜ mutable stateì— ì ‘ê·¼í•˜ëŠ” ê²½ìš° actorì˜ ë™ê¸°í™” ë©”ì»¤ë‹ˆì¦˜ì— ì˜í•´ í•œë²ˆì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ìž‘ì—…ì„ ì²˜ë¦¬í•  ìˆ˜ ìžˆë‹¤. ê·¸ ë™ì•ˆ ë‹¤ë¥¸ ìŠ¤ë ˆë“œëŠ” ê¸°ë‹¤ë¦¬ê³ (await) ìžˆì–´ì•¼ í•˜ê¸° ë•Œë¬¸ì— ì•”ë¬µì ìœ¼ë¡œ actor ì™¸ë¶€ì—ì„œëŠ” ë¹„ë™ê¸°ì ìœ¼ë¡œ ìˆ˜í–‰ì´ ë˜ì•¼ í•  í•„ìš”ê°€ ìžˆëŠ” ê²ƒì´ë‹¤(ê·¸ëž˜ì•¼ ê¸°ë‹¤ë¦´ ìˆ˜ ìžˆìŒ)

    ì°¸ê³  ì‚¬ì´íŠ¸

    - [https://zeddios.tistory.com/1290](https://zeddios.tistory.com/1290)

    ---

    ë³€ìˆ˜ì—ë„ `@MainActor` ë¥¼ ì¶”ê°€í•  ìˆ˜ ìžˆë‹¤.

    ```swift
    // 1. ë³€ìˆ˜ ì„ ì–¸í•˜ê¸°
    @MainActor
    var someNumber: Int = 10

    // 2. ë³€ìˆ˜ ìˆ˜ì •í•˜ê¸°
    someNumber += 10

    // 3. ë³€ìˆ˜ ì°¸ì¡°í•˜ê¸°
    print(someNumber)
    ```

    **ë³€ìˆ˜ ì„ ì–¸í•˜ê¸°**

    ë³€ìˆ˜ì—ë„ `@MainActor` ë¥¼ ì¶”ê°€í•  ìˆ˜ ìžˆë‹¤.

    ë¬¼ë¡  ìƒìˆ˜ì—ë„ í•´ë‹¹ ì–´íŠ¸ë¦¬ë·°íŠ¸ë¥¼ ì¶”ê°€í•  ìˆ˜ ìžˆìŒ. ë‹¤ë§Œ, ì–´ì°¨í”¼ mutationí•˜ì§€ëŠ” ì•Šê¸° ë•Œë¬¸ì— non-isolatedí•œ ì»¨í…ìŠ¤íŠ¸ì—ì„œë„ ì°¸ì¡°ê°€ ê°€ëŠ¥í•˜ë‹¤.

    **ë³€ìˆ˜ ìˆ˜ì •í•˜ê¸°**

    ìœ„ ì½”ë“œì˜ 2ë²ˆê³¼ ê°™ì´ ë³€ìˆ˜ë¥¼ ìˆ˜ì •í•˜ê²Œ ë˜ë©´ ì•„ëž˜ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤.

    *Main actor-isolated var 'someNumber' can not be mutated from a non-isolated context*

    ì§ì—­í•˜ìžë©´ â€œê²©ë¦¬ë˜ì§€ ì•Šì€ ì»¨í…ìŠ¤íŠ¸ì—ì„œëŠ” main-actor isolated ë³€ìˆ˜ì¸ â€˜someNumberâ€™ë¥¼ ë³€í˜•ì‹œí‚¬ ìˆ˜ ì—†ë‹¤.â€ëŠ” ì˜ë¯¸ê°€ ëœë‹¤.

    > <Solution>
    Mutation of this var is only permitted within the actor
    >

    actor ì•ˆì—ì„œë§Œ í•´ë‹¹ ë³€ìˆ˜ ìˆ˜ì •ì´ í—ˆìš©ëœë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.

    `@MainActor` ì–´íŠ¸ë¦¬ë·°íŠ¸ë¥¼ ì¶”ê°€í•œ í•¨ìˆ˜ ì•ˆì—ì„œëŠ” í•´ë‹¹ ë³€ìˆ˜ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìžˆë‹¤.

    **ë³€ìˆ˜ ì°¸ì¡°í•˜ê¸°**

    ìœ„ ì½”ë“œì˜ 3ë²ˆê³¼ ê°™ì´ ë³€ìˆ˜ë¥¼ ì°¸ì¡°í•˜ê²Œ ë˜ë©´ ì•„ëž˜ì™€ ê°™ì€ ì˜¤ë¥˜ê°€ ë°œìƒí•œë‹¤.

    *Main actor-isolated var 'someNumber' can not be referenced from a non-isolated context*

    ë‹¨ìˆœížˆ ë³€ìˆ˜ë¥¼ ì°¸ì¡°í•˜ëŠ” ê²ƒì¼ ë¿ì¸ë°ë„ non-isolatedí•œ ì»¨í…ìŠ¤íŠ¸ì—ì„œëŠ” ì°¸ì¡°ë¥¼ í•  ìˆ˜ ì—†ë‹¤ëŠ” ì—ëŸ¬ê°€ ë–´ë‹¤.

    data raceë¥¼ ìƒê°í•´ë³´ë©´, ì°¸ì¡°â€¦([ì—¬ê¸°](https://www.notion.so/2022-09-16-7507b33e29964a9e8e6fe61392820d0e)ì— í•´ë‹¹ë˜ëŠ” ê¼¬ë¦¬ì§ˆë¬¸ì´ ìƒê°ë‚¨)

    â€”â€”â€”â€”â€”â€”â€”ê¼¬ë¦¬ ì§ˆë¬¸ì— ëŒ€í•œ ì—¬ëŸ¬ ìžë£Œë“¤ì„ ë³¸ í›„

    someNumberëŠ” ë©”ì¸ ì•¡í„°ì— ê³ ë¦½ëœ(Main actor-isolated) ë³€ìˆ˜ì´ë‹¤. ë™ì¼í•œ isolation levelì„ ê°€ì§„ main actorì—ì„œ ì°¸ì¡° ë° ìˆ˜ì •ì´ ê°€ëŠ¥í•˜ë©°, main actorê°€ ì•„ë‹ ê²½ìš° ë¹„ë™ê¸°ì ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ìžˆë‹¤.


### Actorì— ëŒ€í•´

*ActorëŠ” ì—¬ëŸ¬ ìŠ¤ë ˆë“œ(ì•„ë‹˜ Task?)ì—ì„œ ë™ì‹œì— ì ‘ê·¼í•˜ë”ë¼ë„ data raceê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜ì„ ì œê³µí•¨*

â†’ ActorëŠ” ì—¬ëŸ¬ ìŠ¤ë ˆë“œ(ì•„ë‹˜ Task?)ì—ì„œ ë™ì‹œì— â€œê³µìœ ëœ mutable stateì—â€ ì ‘ê·¼í•˜ë”ë¼ë„ data raceê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡ í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜ì„ ì œê³µí•¨

- ActorëŠ” í´ëž˜ìŠ¤ì™€ ìœ ì‚¬í•˜ë‹¤. ì°¸ì¡°íƒ€ìž…ì´ê³ , ë‚´ë¶€ì ìœ¼ë¡œ í”„ë¡œí¼í‹°ì™€ ë©”ì†Œë“œë¥¼ ê°€ì§€ë©° ì´ë‹ˆì…œë¼ì´ì €ë¥¼ ê°€ì§ˆ ìˆ˜ ìžˆê³ , extension ê°€ëŠ¥í•˜ë©° protocol ì±„íƒë„ ê°€ëŠ¥í•˜ë‹¤.
- í´ëž˜ìŠ¤ì™€ ì°¨ì´ê°€ ìžˆë‹¤ë©´ ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ë™ì‹œì— Actor ì•ˆì˜ mutableí•œ í”„ë¡œí¼í‹°ì— ì ‘ê·¼í–ˆì„ ë•Œ í•œë²ˆì— í•˜ë‚˜ì”© ì ‘ê·¼(ë™ê¸°í™” ëœ ì ‘ê·¼)ì´ ê°€ëŠ¥í•˜ë„ë¡ í•˜ëŠ” ë©”ì»¤ë‹ˆì¦˜ì„ ì œê³µí•œë‹¤ëŠ” ê²ƒ. ë˜í•œ ìƒì†ì´ ë¶ˆê°€í•˜ë‹¤ëŠ” íŠ¹ì§•ì´ ìžˆë‹¤.
- Actor ì™¸ë¶€ì—ì„œ Actorì˜ mutable stateì— ë™ì‹œì— ì ‘ê·¼í•˜ëŠ” ê²½ìš° í•˜ë‚˜ì˜ ìž‘ì—…ì´ ì²˜ë¦¬ë  ë•Œê¹Œì§€ ë‹¤ë¥¸ í•˜ë‚˜ëŠ” ëŒ€ê¸°(await) í•˜ê³  ìžˆì–´ì•¼ í•˜ë¯€ë¡œ Actor ì™¸ë¶€ì—ì„œëŠ” ë¹„ë™ê¸°ì‹ìœ¼ë¡œ actorì— ì ‘ê·¼í•´ì•¼ í•œë‹¤.
- Test Code in Playground

    ```swift
    actor SomeActor {
        private var someValue: Int = 10

        func justFunction() {
            print("call just function")
        }

        func relatedFunction(addValue: Int) {
            print("call related function with value(\(addValue))")
            someValue += addValue
            print("adding process done!")
        }
    }
    ```

    justFunction()ì˜ ê²½ìš° ë‚´ë¶€ì ìœ¼ë¡œ mutable stateë¥¼ ì°¸ì¡°í•˜ê³  ìžˆì§„ ì•Šì§€ë§Œ, actor ì™¸ë¶€ì—ì„œ ì ‘ê·¼í•  ë•ŒëŠ” ë‹¤ë¥¸ ê²ƒë“¤ê³¼ ë§ˆì°¬ê°€ì§€ë¡œ ë¹„ë™ê¸°ì ìœ¼ë¡œ í˜¸ì¶œì´ ë˜ì–´ì•¼ í•œë‹¤.


**Actorë¼ëŠ” ê°œë…ì´ ì œì•ˆëœ ì´ìœ **

> ì¶œì²˜ : [swift-evolution, Actors](https://github.com/apple/swift-evolution/blob/7bb95b10762383a3ecb3ab7e4e9dd58dea89c90f/proposals/0306-actors.md)
We want to provide the ability to use shared mutable state while still providing static detection of data races and other common concurrency bugs.
ìš°ë¦¬ëŠ” data race ë° ê¸°íƒ€ ë™ì‹œì„± ë²„ê·¸ì— ëŒ€í•œ ì •ì  detectionì„ ì œê³µí•˜ë©´ì„œë„, ê³µìœ ëœ mutable stateë¥¼ ì‚¬ìš©í•  ìˆ˜ ìžˆë„ë¡ ë§Œë“¤ê³  ì‹¶ì—ˆë‹¤. â†’ ê·¸ëž˜ì„œ Actorë¥¼ ì œì•ˆí•¨.
>

[actor model](https://en.wikipedia.org/wiki/Actor_model) ê°œë…ìœ¼ë¡œë¶€í„° ì˜í–¥ì„ ë°›ì€ ê²ƒìœ¼ë¡œ ë³´ìž„.

Actorì˜ ì—­í• 

- **concurrency ë„ë©”ì¸ ë‚´**ì—ì„œ beg of state(state ê¾¸ëŸ¬ë¯¸)ë¥¼ ê°€ì§€ê³  ìžˆì„ ìˆ˜ ìžˆë„ë¡ í•˜ê³ , ì—¬ê¸°ì— actí•˜ëŠ” ì—¬ëŸ¬ê°œì˜ operationì„ ì •ì˜í•  ìˆ˜ ìžˆë„ë¡ í•œë‹¤.(classëž‘ ë¹„ìŠ·í•œë° â€œconcurrency ë„ë©”ì¸ ë‚´ì—ì„œâ€ê°€ ê°€ìž¥ í° ì°¨ì´ì¸ ê²ƒ ê°™ë‹¤.)
- ê°ê°ì˜ actorëŠ” ìžê¸° ìžì‹ ì´ ê°€ì§€ê³  ìžˆëŠ” data(beg of state)ë¥¼ â€œdata isolationâ€ì„ í†µí•´ ë³´í˜¸í•œë‹¤: ì—¬ê¸°ì„œ data isolationì´ëž€ ì£¼ì–´ì§„ ì‹œê°„ë™ì•ˆ ì˜¤ì§ í•œê°œì˜ ìŠ¤ë ˆë“œë§Œ í•´ë‹¹ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìžˆìŒì„ ë³´ìž¥í•¨.

Actor isolation

- Actor isolationì€ actorê°€ ìžì‹ ì´ ê°€ì§€ê³  ìžˆëŠ” mutable stateë¥¼ ë³´í˜¸í•˜ëŠ” ë°©ë²•ì´ë‹¤.
- actorì—ê²Œ ìžˆì–´, mutable stateë¥¼ ë³´í˜¸í•˜ëŠ” ê¸°ë³¸ì ì¸ ë©”ì»¤ë‹ˆì¦˜ì€ ì˜¤ì§ ìžì‹ ë“¤ì´ ê°€ì§€ê³  ìžˆëŠ” stored instance propertiesë“¤ì„  `self` ë¥¼ í†µí•´ì„œë§Œ ì ‘ê·¼ë˜ì–´ì§€ë„ë¡ í•˜ëŠ” ê²ƒì´ë‹¤.(For actors, the primary mechanism for this protection is by only allowing their stored instance properties to be accessed directly onÂ `self`.)

ì°¸ê³  ì‚¬ì´íŠ¸

- [https://zeddios.tistory.com/1290](https://zeddios.tistory.com/1290)

### â€œnon-isolatedí•œ ì»¨í…ìŠ¤íŠ¸â€ì— ëŒ€í•´ ìž˜ ëª¨ë¥´ê³  ìžˆë‹¤. ì–´ë–¤ ì˜ë¯¸ë¥¼ ê°€ì§€ëŠ”ê±´ì§€?

Actorì˜ isolationì— ëŒ€í•´ ë‹¤ì‹œ ë³´ìž.

actor-isolated : actorì— ê³ ë¦½ëœ == actorë¥¼ í†µí•´ì„œë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•œ

non-isolated : actor-isolatedê°€ ì•„ë‹Œ ì •ì˜ë“¤ì„ ê°€ë¦¬ì¼œ non-isolatedë¼ê³  í•¨.

[ì´ ë¸”ë¡](https://www.notion.so/2022-09-16-7507b33e29964a9e8e6fe61392820d0e)ì—ë„ ì í˜€ìžˆëŠ” ê²ƒì²˜ëŸ¼, actorê°€ ìžì‹ ì´ ì†Œìœ í•œ mutable stateë¥¼ ë³´í˜¸í•˜ëŠ” ë°©ë²•ì€ ìžê¸° ìžì‹ (`self`)ì„ í†µí•´ì„œë§Œ ì ‘ê·¼ë˜ì–´ì§€ë„ë¡ ë§Œë“œëŠ” ê²ƒì´ë‹¤.

â€œnon-isolatedí•œ ì»¨í…ìŠ¤íŠ¸â€ëŠ” actorê°€ ì†Œìœ í•œ actor-isolated í”„ë¡œí¼í‹°ë‚˜ ë©”ì†Œë“œë“¤ì„ actor ì¸ìŠ¤í„´ìŠ¤ ì™¸ë¶€ì—ì„œ í˜¸ì¶œí•˜ëŠ” ê²½ìš°ë¥¼ ì˜ë¯¸í•œë‹¤.(self(Actor)ë¥¼ í†µí•´ actor-isolated ì„ ì–¸ë“¤ì„ í˜¸ì¶œí•  ìˆ˜ ì—†ëŠ” ê²½ìš°) ì´ëŸ° ê²½ìš°ë¥¼ cross-actor referenceë¼ê³  í•˜ë©°, í˜¸ì¶œí•  ìˆ˜ ìžˆëŠ” ë°©ë²•ì€ ë‘ê°€ì§€ë¡œ ìƒìˆ˜ë¡œ ë³€ê²½í•˜ë˜ê°€ ë¹„ë™ê¸°ì ìœ¼ë¡œ í˜¸ì¶œí•˜ëŠ” ë°©ë²•ì´ ìžˆë‹¤.

- Test Code in Playground

    ```swift
    //: [Previous](@previous)

    import Foundation
    import Combine

    actor BankAccount {
        let accountNumber: Int // ê³„ì¢Œ ë²ˆí˜¸
        var balance: Double    // ê³„ì¢Œ ìž”ì•¡

        init(accountNumber: Int, initialDeposit: Double) {
            self.accountNumber = accountNumber
            self.balance = initialDeposit
        }
    }

    extension BankAccount {
        enum BankError: Error {
            case insufficientFunds
        }

        func transfer(amount: Double, to other: BankAccount) throws {
            if amount > self.balance {
                throw BankError.insufficientFunds
            }

            print("Transferring \(amount) from \(accountNumber) to \(other.accountNumber)")

            self.balance = balance - amount

            /// 1. ë‹¤ë¥¸ Actorì˜ mutable state ì°¸ì¡°í•˜ê¸°
    				print(other.balance)
            /// 2. ë‹¤ë¥¸ Actorì˜ mutable state ë³€ê²½í•˜ê¸°
            other.balance = other.balance + amount
        }
    }
    ```

    **ë‹¤ë¥¸ Actorì˜ mutable state ì°¸ì¡°í•˜ê¸°**

    1ë²ˆì²˜ëŸ¼ ì°¸ì¡°í•˜ë©´ ì•„ëž˜ì™€ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•¨.

    *actor-isolated property 'balance' can not be referenced on a non-isolated actor instance*

    letìœ¼ë¡œ ì„ ì–¸ëœ accountNumberê°€ ì •ìƒì ìœ¼ë¡œ ì°¸ì¡°ë˜ì—ˆë˜ ê²ƒê³¼ëŠ” ëŒ€ì¡°ë˜ëŠ” ê²°ê³¼.

    **ë‹¤ë¥¸ Actorì˜ mutable state ë³€ê²½í•˜ê¸°**

    2ë²ˆê³¼ ê°™ì´ ë§¤ê°œë³€ìˆ˜ë¡œ ë“¤ì–´ì˜¨ actorì˜ í”„ë¡œí¼í‹°ë¥¼ ìˆ˜ì •í•˜ë©´ ì•„ëž˜ì™€ ê°™ì€ ì—ëŸ¬ê°€ ë°œìƒí•¨.

    *actor-isolated property 'balance' can not be mutated on a non-isolated actor instance*

    ë‘˜ë‹¤ non-isolated ì•¡í„° ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ìˆ˜ì •/ì°¸ì¡°í•  ìˆ˜ ì—†ë‹¤ëŠ” ë©”ì„¸ì§€ìž„.

    ìœ„ ì½”ë“œì˜ `other` ëŠ” í˜„ìž¬ ë©”ì†Œë“œê°€ ì •ì˜ë˜ì–´ ìžˆëŠ” BankAccountì™€ ë™ì¼í•œ íƒ€ìž…ì´ì§€ë§Œ actor ì™¸ë¶€ì—ì„œ ìƒì„±í•œ ì¸ìŠ¤í„´ìŠ¤ê°€ ë§¤ê°œë³€ìˆ˜ë¡œ ì „ë‹¬ë˜ëŠ” ê²ƒì´ê¸° ë•Œë¬¸ì— ë©”ì†Œë“œê°€ ì‹¤í–‰ë˜ëŠ” ì¸ìŠ¤í„´ìŠ¤ì™€ëŠ” ì„œë¡œ ë‹¤ë¥¸ ê²ƒì´ë‹¤.(ì„œë¡œ ë‹¤ë¥¸ isolationì„ ê°€ì§„ë‹¤ê³  ì´í•´í•¨) ë”°ë¼ì„œ selfë¡œ ì ‘ê·¼í•  ìˆ˜ ì—†ìŒ. otherì—ê²Œ ìžˆì–´ í˜„ìž¬ ë©”ì†Œë“œê°€ ì‹¤í–‰ë˜ëŠ” actorëŠ” non-isolated actor ì¸ìŠ¤í„´ìŠ¤ì¸ ê²ƒì´ë‹¤.

    balanceëŠ” selfì—ì„œë§Œ ì°¸ì¡°ë  ìˆ˜ ìžˆê¸° ë•Œë¬¸ìž„.(actor-isolated property â€˜balanceâ€™ can only be referenced on â€˜selfâ€™ â† ë‚´ê°€ ì°¸ê³ í•œ ë¸”ë¡œê·¸ì—ëŠ” ì´ëŸ° ì—ëŸ¬ê°€ ë–´ë‹¤ê³  í•¨. ë‚œ ì•ˆë–´ì§€ë§Œ..)

    ì¦‰, selfë¥¼ í†µí•´ì„œë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì˜ë¯¸ë‹¤.

    **actor-isolated property**

    actor ì•ˆì— ì •ì˜ëœ stored, computed ì¸ìŠ¤í„´ìŠ¤ í”„ë¡œí¼í‹°ë“¤ / ì¸ìŠ¤í„´ìŠ¤ ë©”ì†Œë“œë“¤ / ì¸ìŠ¤í„´ìŠ¤ ì„œë¸ŒìŠ¤í¬ë¦½íŠ¸ë“¤ì€ ëª¨ë‘ actor-isolated ìƒíƒœë¼ê³  í•¨.

    > ì¶œì²˜ : [swift evolution, Actors](https://github.com/apple/swift-evolution/blob/7bb95b10762383a3ecb3ab7e4e9dd58dea89c90f/proposals/0306-actors.md)
    `balance`Â isÂ *actor-isolated*, meaning that it can only be accessed directly from within the specific actor it is tied to or "isolated by".
    ì—°ê²°ë˜ê±°ë‚˜(tied to) ê²©ë¦¬ëœ(isolated by) íŠ¹ì • actor ì•ˆì—ì„œë§Œ ì ‘ê·¼ì´ ê°€ëŠ¥í•˜ë‹¤.
    >

    > ì¶œì²˜ : [swift evolution, Actors](https://github.com/apple/swift-evolution/blob/7bb95b10762383a3ecb3ab7e4e9dd58dea89c90f/proposals/0306-actors.md)
    Any declaration that is not actor-isolated isÂ *non-isolated*Â and cannot synchronously access any actor-isolated declaration.
    **non-isolated**ë¼ëŠ” ê²ƒì€ actor-isolatedê°€ ì•„ë‹Œ ê²ƒë“¤ì„ ì˜ë¯¸í•˜ë©° actor-isolated ì„ ì–¸ì— ë™ê¸°ì ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤.
    >

    actor-isolated ì •ì˜ë“¤ì€ ì„œë¡œ ì„œë¡œ ìžìœ ë¡­ê²Œ ì°¸ì¡°í•  ìˆ˜ ìžˆìœ¼ë‚˜, non-isolated ì •ì˜ë“¤ì€ actor-isolated ì •ì˜ì— ë™ê¸°ì ìœ¼ë¡œ ì ‘ê·¼í•  ìˆ˜ ì—†ë‹¤(ë¹„ë™ê¸° ì ‘ê·¼ì€ ê°€ëŠ¥)

    - **cross-actor reference**

        > A reference to an actor-isolated declaration from outside that actor
        >
        >
        > í•´ë‹¹ ì•¡í„° ì™¸ë¶€ì—ì„œ actor-isolated ì„ ì–¸(ì €ìž¥,ì—°ì‚° í”„ë¡œí¼í‹°ë‚˜ ì¸ìŠ¤í„´ìŠ¤ ë©”ì†Œë“œ ë“±)ì„ ì°¸ì¡°í•˜ëŠ” ê²ƒì„ cross-actor referenceë¼ê³  í•¨.
        >

        ìœ„ ì½”ë“œì—ì„œëŠ” `other.balance` ë¥¼ ì°¸ì¡°í•˜ëŠ” ê²ƒì´ cross-actor referenceì´ë‹¤.

        ì´ëŸ° ì°¸ì¡°ëŠ” ë‘ê°€ì§€ ë°©ì‹ìœ¼ë¡œ í—ˆìš©ë  ìˆ˜ ìžˆë‹¤.

        1. immutable stateì— ëŒ€í•œ cross-actor referenceëŠ” í—ˆìš© ê°€ëŠ¥(ë‹¨, í•´ë‹¹ ì•¡í„°ê°€ ì •ì˜ëœ ëª¨ë“ˆê³¼ ë™ì¼í•œ ê³³ì—ì„œë§Œ í—ˆìš©) ì™œëƒí•˜ë©´ í•œë²ˆ ì •ì˜ë˜ê³  ë‚˜ë©´ ì•¡í„° ë‚´/ì™¸ë¶€ì—ì„œ ìˆ˜ì •ì´ ë¶ˆê°€í•˜ê¸° ë•Œ ë¬¸ì´ë‹¤.(ê·¸ëž˜ì„œ data race ê°€ ë°œìƒí•˜ì§€ ì•Šê¸° ë•Œë¬¸)

            ì´ ê·œì¹™ìœ¼ë¡œ `other.accountNumber`ëŠ” ì •ìƒì ìœ¼ë¡œ ì°¸ì¡°ê°€ ê°€ëŠ¥í•˜ë‹¤.

        2. ë¹„ë™ê¸° í•¨ìˆ˜ë¡œ í˜¸ì¶œí•˜ëŠ” ê²ƒ

            ë¹„ë™ê¸° í•¨ìˆ˜ í˜¸ì¶œì€ actorì— ëŒ€í•œ messageë¡œ í•´ì„ëœë‹¤. actorì˜ â€œmailboxâ€ì— ì´ëŸ° messageë“¤ì´ ì €ìž¥ë˜ë©° callerëŠ” awaitë  ìˆ˜ ìžˆë‹¤. actorëŠ” â€œmailboxâ€ì— ìžˆëŠ” ê²ƒì„ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤.

            > ì¶œì²˜ : [swift evolution, Actors](https://github.com/apple/swift-evolution/blob/7bb95b10762383a3ecb3ab7e4e9dd58dea89c90f/proposals/0306-actors.md)
            An actor processes the messages in its mailbox sequentially, so that a given actor will never have two concurrently-executing tasks running actor-isolated code.
            >
